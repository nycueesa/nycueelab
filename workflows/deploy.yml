name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci
          version: latest

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸš€ é–‹å§‹éƒ¨ç½² Eesa-web å°ˆæ¡ˆ..."
            
            # åˆ‡æ›åˆ°å°ˆæ¡ˆç›®éŒ„
            cd /home/user/eesa-web
            
            # ç¢ºä¿å¾ main åˆ†æ”¯æ‹‰å–æœ€æ–°ç‰ˆæœ¬
            echo "ğŸ“¦ æ­£åœ¨å¾ main åˆ†æ”¯æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼..."
            git fetch origin
            git checkout main
            git pull origin main
            
            # åŸ·è¡Œåœç”¨è…³æœ¬ï¼Œæ¸…ç†èˆŠçš„éƒ¨ç½²ç’°å¢ƒ
            echo "ğŸ›‘ æ­£åœ¨åœç”¨èˆŠçš„éƒ¨ç½²ç’°å¢ƒ..."
            ./stop.sh
            
            # ç­‰å¾…å®¹å™¨å®Œå…¨åœæ­¢
            echo "â³ ç­‰å¾…å®¹å™¨å®Œå…¨åœæ­¢..."
            sleep 5
            
            # åŸ·è¡Œéƒ¨ç½²è…³æœ¬
            echo "ğŸš€ æ­£åœ¨åŸ·è¡Œæ–°çš„éƒ¨ç½²..."
            ./run.sh
            
            # ç­‰å¾…æœå‹™å•Ÿå‹•ä¸¦æª¢æŸ¥ç‹€æ…‹
            echo "ğŸ” æª¢æŸ¥éƒ¨ç½²ç‹€æ…‹..."
            sleep 5
            docker compose -f docker-compose.dev.yml ps
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
